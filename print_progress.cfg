# Print Progress LED Indicator
# Shows print progress on back cabinet LEDs (19-28 = 10 LEDs)
# While printing:
# - Toolhead LEDs: White (illumination)
# - Left/Right Cabinet (1-18, 29-46): White (chamber lighting)
# - Back Cabinet (19-28): Progress bar (0-100%)
#
# Copyright 2025 Mike Henderson

[gcode_macro UPDATE_PRINT_PROGRESS]
description: Update back cabinet LEDs to show print progress percentage
gcode:
    {% set progress = printer.display_status.progress %}
    {% set leds_lit = ((progress * 10) | int) %}  # 0-10 LEDs based on 0-100% progress

    # Turn off all back cabinet LEDs first
    {% for i in range(19, 29) %}
        SET_LED LED=CabinetLights RED=0 GREEN=0 BLUE=0 INDEX={i} TRANSMIT=0
    {% endfor %}

    # Light up LEDs based on progress (green for completed portion)
    {% for i in range(19, 19 + leds_lit) %}
        SET_LED LED=CabinetLights RED=0 GREEN=1.0 BLUE=0 INDEX={i} TRANSMIT=0
    {% endfor %}

    # Transmit all changes at once
    {% if leds_lit > 0 %}
        SET_LED LED=CabinetLights RED=0 GREEN=1.0 BLUE=0 INDEX={18 + leds_lit} TRANSMIT=1
    {% else %}
        SET_LED LED=CabinetLights RED=0 GREEN=0 BLUE=0 INDEX=19 TRANSMIT=1
    {% endif %}

[gcode_macro PRINT_LIGHTS_ON]
description: Set LEDs for active printing (toolhead+sides=white, back=progress)
gcode:
    # Set toolhead to white
    STOP_LED_EFFECTS
    SET_LED LED=hotend_rgb RED=0 GREEN=0 BLUE=0 WHITE=1.0

    # Set left and right sides to white
    CABINET_RIGHT RED=1.0 GREEN=1.0 BLUE=1.0
    CABINET_LEFT RED=1.0 GREEN=1.0 BLUE=1.0

    # Initialize progress bar on back
    UPDATE_PRINT_PROGRESS

[delayed_gcode UPDATE_PROGRESS_LEDS]
initial_duration: 0
gcode:
    {% if printer.print_stats.state == "printing" %}
        UPDATE_PRINT_PROGRESS
        UPDATE_DELAYED_GCODE ID=UPDATE_PROGRESS_LEDS DURATION=5  # Update every 5 seconds
    {% endif %}

[gcode_macro START_PROGRESS_INDICATOR]
description: Start the print progress LED updates
gcode:
    PRINT_LIGHTS_ON
    UPDATE_DELAYED_GCODE ID=UPDATE_PROGRESS_LEDS DURATION=5

[gcode_macro STOP_PROGRESS_INDICATOR]
description: Stop the print progress LED updates
gcode:
    UPDATE_DELAYED_GCODE ID=UPDATE_PROGRESS_LEDS DURATION=0
    # Restore normal lighting
    STATUS_READY
    CABINET_WHITE